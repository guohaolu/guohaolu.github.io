<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"guohaolu.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12,"visitor":true,"social":true,"categories":true,"tags":true,"toc":{"enable":true,"number":true,"wrap":true}},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="分享技术，记录生活">
<meta property="og:type" content="website">
<meta property="og:title" content="Guohao Lu&#39;s Blog">
<meta property="og:url" content="https://guohaolu.github.io/index.html">
<meta property="og:site_name" content="Guohao Lu&#39;s Blog">
<meta property="og:description" content="分享技术，记录生活">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="guohao.lu">
<meta property="article:tag" content="技术,博客,编程">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://guohaolu.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Guohao Lu's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Guohao Lu's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">个人技术博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">guohao.lu</p>
  <div class="site-description" itemprop="description">分享技术，记录生活</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/guohaolu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;guohaolu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1670212878@qq.com" title="E-Mail → mailto:1670212878@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E4%BD%8D%E7%BD%AE%E9%87%8D%E7%BD%AE%E5%BC%80%E9%94%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E4%BD%8D%E7%BD%AE%E9%87%8D%E7%BD%AE%E5%BC%80%E9%94%80/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Rebalance后消费位置重置的问题"><a href="#Rebalance后消费位置重置的问题" class="headerlink" title="Rebalance后消费位置重置的问题"></a>Rebalance后消费位置重置的问题</h1><ol>
<li><p><strong>可能带来的问题</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">场景示例：</span><br><span class="line">Consumer1原本消费Partition0：</span><br><span class="line">┌───────────────────────────┐</span><br><span class="line">│     Partition 0          │</span><br><span class="line">│ offset: 1000000 -&gt; 1500000│</span><br><span class="line">└───────────────────────────┘</span><br><span class="line"></span><br><span class="line">Rebalance后分配给Consumer2：</span><br><span class="line">1. 需要初始化消费位置</span><br><span class="line">2. 可能需要建立新的TCP连接</span><br><span class="line">3. 重新填充消费者缓存</span><br><span class="line">4. 可能导致重复消费</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能影响</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">主要开销：</span><br><span class="line">1. 状态重建</span><br><span class="line">   - 重新加载消费位置</span><br><span class="line">   - 重建内部缓存</span><br><span class="line">   </span><br><span class="line">2. 网络开销</span><br><span class="line">   - 建立新的TCP连接</span><br><span class="line">   - 首次拉取数据</span><br><span class="line">   </span><br><span class="line">3. 消费延迟</span><br><span class="line">   - 处理暂停</span><br><span class="line">   - 消息积压增加</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>优化方案</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 使用StickyAssignor策略</span></span><br><span class="line">properties.put(</span><br><span class="line">    ConsumerConfig.PARTITION_ASSIGNMENT_STRATEGY_CONFIG,</span><br><span class="line">    <span class="string">&quot;org.apache.kafka.clients.consumer.StickyAssignor&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 合理配置缓存大小</span></span><br><span class="line">properties.put(</span><br><span class="line">    ConsumerConfig.FETCH_MAX_BYTES_CONFIG,</span><br><span class="line">    <span class="string">&quot;5242880&quot;</span>  <span class="comment">// 5MB</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 实现优雅的偏移量管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;TopicPartition, OffsetAndMetadata&gt; currentOffsets </span><br><span class="line">        = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;my-topic&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(ConsumerRecord&lt;String, String&gt; record)</span> &#123;</span><br><span class="line">        <span class="comment">// 处理消息</span></span><br><span class="line">        processMessage(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录偏移量</span></span><br><span class="line">        currentOffsets.put(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TopicPartition</span>(record.topic(), record.partition()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">OffsetAndMetadata</span>(record.offset() + <span class="number">1</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Rebalance监听器</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">SaveOffsetOnRebalance</span> <span class="keyword">implements</span> <span class="title class_">ConsumerRebalanceListener</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPartitionsRevoked</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span> &#123;</span><br><span class="line">            <span class="comment">// Rebalance前提交偏移量</span></span><br><span class="line">            consumer.commitSync(currentOffsets);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>最佳实践</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1. 减少Rebalance频率</span><br><span class="line">   - 合理设置session.timeout.ms</span><br><span class="line">   - 避免频繁重启消费者</span><br><span class="line"></span><br><span class="line">2. 优化消费者配置</span><br><span class="line">   - 使用StickyAssignor</span><br><span class="line">   - 合理设置fetch.max.bytes</span><br><span class="line">   - 启用消费者缓存</span><br><span class="line"></span><br><span class="line">3. 监控指标</span><br><span class="line">   - 消费延迟</span><br><span class="line">   - Rebalance频率</span><br><span class="line">   - 处理时间</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>新版本优化(Kafka 2.4+)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">增量式Rebalance：</span><br><span class="line">1. 只对变更的分区进行重分配</span><br><span class="line">2. 未变更的分区继续消费</span><br><span class="line">3. 显著减少重平衡影响</span><br><span class="line"></span><br><span class="line">Cooperative Rebalancing：</span><br><span class="line">1. 两阶段提交过程</span><br><span class="line">2. 允许消费者继续处理未撤销的分区</span><br><span class="line">3. 减少消费中断时间</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka消息消费失败处理方案"><a href="#Kafka消息消费失败处理方案" class="headerlink" title="Kafka消息消费失败处理方案"></a>Kafka消息消费失败处理方案</h1><ol>
<li><p><strong>重试机制设计</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaConsumerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConsumerFactory&lt;String, Object&gt; <span class="title function_">consumerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 禁用自动提交</span></span><br><span class="line">        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 从最早的消息开始消费</span></span><br><span class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">&quot;earliest&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaConsumerFactory</span>&lt;&gt;(props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReviewService</span> &#123;</span><br><span class="line">    <span class="meta">@KafkaListener(</span></span><br><span class="line"><span class="meta">        topics = &quot;incentive.qualification.changed.v1&quot;,</span></span><br><span class="line"><span class="meta">        groupId = &quot;review-service-group&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@RetryableKafkaHandler(</span></span><br><span class="line"><span class="meta">        attempts = &quot;3&quot;,</span></span><br><span class="line"><span class="meta">        backoff = @Backoff(delay = 1000, multiplier = 2)</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleQualificationChanged</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Payload</span> QualificationChangedEvent event,</span></span><br><span class="line"><span class="params">            Acknowledgment ack)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 业务处理</span></span><br><span class="line">            processEvent(event);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 确认消息</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 3. 重试次数达到上限，进入死信队列</span></span><br><span class="line">            <span class="keyword">if</span> (!isRetryable(e)) &#123;</span><br><span class="line">                sendToDLQ(event);</span><br><span class="line">                ack.acknowledge();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e; <span class="comment">// 触发重试</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>死信队列处理</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 死信队列配置</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TopicBuilder <span class="title function_">deadLetterTopic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> TopicBuilder.name(<span class="string">&quot;incentive.dlq.v1&quot;</span>)</span><br><span class="line">           .partitions(<span class="number">3</span>)</span><br><span class="line">           .replicas(<span class="number">3</span>)</span><br><span class="line">           .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 死信消息处理服务</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterService</span> &#123;</span><br><span class="line">    <span class="meta">@KafkaListener(</span></span><br><span class="line"><span class="meta">        topics = &quot;incentive.dlq.v1&quot;,</span></span><br><span class="line"><span class="meta">        groupId = &quot;dlq-processor-group&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDLQ</span><span class="params">(ConsumerRecord&lt;String, String&gt; record)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 记录错误日志</span></span><br><span class="line">        log.error(<span class="string">&quot;Processing DLQ message: &#123;&#125;&quot;</span>, record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 错误通知</span></span><br><span class="line">        notifyOperators(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 持久化到错误表</span></span><br><span class="line">        saveToErrorTable(record);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 手动重试接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">retryMessage</span><span class="params">(String messageId)</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> errorRepository.find(messageId);</span><br><span class="line">        kafkaTemplate.send(msg.getOriginalTopic(), </span><br><span class="line">                         msg.getKey(), </span><br><span class="line">                         msg.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>错误数据持久化</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;kafka_error_messages&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorMessage</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String messageId;</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> String payload;</span><br><span class="line">    <span class="keyword">private</span> String errorMsg;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> retryCount;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="keyword">private</span> MessageStatus status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MessageStatus</span> &#123;</span><br><span class="line">    FAILED,      <span class="comment">// 失败待处理</span></span><br><span class="line">    RETRYING,    <span class="comment">// 重试中</span></span><br><span class="line">    RESOLVED     <span class="comment">// 已解决</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>监控告警机制</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaMonitor</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 消费延迟监控</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 60000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkLag</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;TopicPartition, Long&gt; lags = getLags();</span><br><span class="line">        <span class="keyword">if</span> (isLagTooHigh(lags)) &#123;</span><br><span class="line">            alertService.send(<span class="string">&quot;消费延迟过高&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 错误率监控</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 60000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkErrorRate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">errorRate</span> <span class="operator">=</span> getErrorRate();</span><br><span class="line">        <span class="keyword">if</span> (errorRate &gt; threshold) &#123;</span><br><span class="line">            alertService.send(<span class="string">&quot;错误率过高&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>补偿机制</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompensationService</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 定时补偿</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 */1 * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compensate</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ErrorMessage&gt; errors = </span><br><span class="line">            errorRepository.findUnresolved();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (ErrorMessage error : errors) &#123;</span><br><span class="line">            <span class="comment">// 根据业务类型选择补偿策略</span></span><br><span class="line">            <span class="type">CompensationStrategy</span> <span class="variable">strategy</span> <span class="operator">=</span> </span><br><span class="line">                getStrategy(error.getTopic());</span><br><span class="line">            strategy.compensate(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 手动补偿接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">manualCompensate</span><span class="params">(String messageId)</span> &#123;</span><br><span class="line">        <span class="type">ErrorMessage</span> <span class="variable">error</span> <span class="operator">=</span> </span><br><span class="line">            errorRepository.find(messageId);</span><br><span class="line">        retryMessage(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka消费者组-Consumer-Group-详解"><a href="#Kafka消费者组-Consumer-Group-详解" class="headerlink" title="Kafka消费者组(Consumer Group)详解"></a>Kafka消费者组(Consumer Group)详解</h1><ol>
<li><p><strong>基本概念</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">消费者组定义：</span><br><span class="line">- 多个消费者实例组成的逻辑分组</span><br><span class="line">- 共同消费一个或多个主题</span><br><span class="line">- 每个消费者组有唯一的group.id</span><br><span class="line"></span><br><span class="line">消费模型：</span><br><span class="line">┌─────────────┐</span><br><span class="line">│   Topic-A   │</span><br><span class="line">│ Partition 0 │────┐</span><br><span class="line">│ Partition 1 │──┐ │</span><br><span class="line">│ Partition 2 │┐ │ │    Consumer Group X</span><br><span class="line">└─────────────┘│ │ │  ┌─────────────────┐</span><br><span class="line">               │ │ └──►│   Consumer 1    │</span><br><span class="line">               │ └────►│   Consumer 2    │</span><br><span class="line">               └──────►│   Consumer 3    │</span><br><span class="line">                      └─────────────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>关键特性</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. 分区所有权</span><br><span class="line">   - 一个分区只能被组内一个消费者消费</span><br><span class="line">   - 一个消费者可以消费多个分区</span><br><span class="line"></span><br><span class="line">2. 负载均衡</span><br><span class="line">   - 组内成员自动分配分区</span><br><span class="line">   - 支持动态扩缩容</span><br><span class="line"></span><br><span class="line">3. 消费位置管理</span><br><span class="line">   - 每个组独立维护消费位置</span><br><span class="line">   - 支持从任意位置开始消费</span><br><span class="line"></span><br><span class="line">4. 故障转移</span><br><span class="line">   - 自动检测消费者故障</span><br><span class="line">   - 自动重新分配分区</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>消费者组状态</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">状态流转：</span><br><span class="line">Empty ──► PreparingRebalance ──► CompletingRebalance ──► Stable</span><br><span class="line">  ▲                                                        │</span><br><span class="line">  └────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">主要状态：</span><br><span class="line">1. Empty: 组内无成员</span><br><span class="line">2. PreparingRebalance: 准备开始重平衡</span><br><span class="line">3. CompletingRebalance: 完成分区分配</span><br><span class="line">4. Stable: 稳定状态，正常消费</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者组配置</span></span><br><span class="line"><span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">props.put(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;my-group&quot;</span>);           <span class="comment">// 组ID</span></span><br><span class="line">props.put(<span class="string">&quot;enable.auto.commit&quot;</span>, <span class="string">&quot;true&quot;</span>);     <span class="comment">// 自动提交</span></span><br><span class="line">props.put(<span class="string">&quot;auto.commit.interval.ms&quot;</span>, <span class="string">&quot;1000&quot;</span>); <span class="comment">// 提交间隔</span></span><br><span class="line">props.put(<span class="string">&quot;session.timeout.ms&quot;</span>, <span class="string">&quot;30000&quot;</span>);    <span class="comment">// 会话超时</span></span><br><span class="line">props.put(<span class="string">&quot;max.poll.interval.ms&quot;</span>, <span class="string">&quot;300000&quot;</span>); <span class="comment">// 最大轮询间隔</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建消费者</span></span><br><span class="line">KafkaConsumer&lt;String, String&gt; consumer = </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅主题</span></span><br><span class="line">consumer.subscribe(Arrays.asList(<span class="string">&quot;my-topic&quot;</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>消费示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupConsumerExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 批量拉取消息</span></span><br><span class="line">                ConsumerRecords&lt;String, String&gt; records = </span><br><span class="line">                    consumer.poll(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 处理消息</span></span><br><span class="line">                <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">                    processRecord(record);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 异步提交位移</span></span><br><span class="line">                consumer.commitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 同步提交最后的位移</span></span><br><span class="line">                consumer.commitSync();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                consumer.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>常见使用场景</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. 消息队列模式</span><br><span class="line">   - 一个分区一个消费者</span><br><span class="line">   - 组内负载均衡</span><br><span class="line">   </span><br><span class="line">2. 发布订阅模式</span><br><span class="line">   - 多个消费者组</span><br><span class="line">   - 每个组都收到全量消息</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">Topic-A ──► Consumer Group 1 (日志处理)</span><br><span class="line">       └──► Consumer Group 2 (数据分析)</span><br><span class="line">       └──► Consumer Group 3 (监控告警)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>监控指标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">关键指标：</span><br><span class="line">1. 消费延迟(lag)</span><br><span class="line">2. 消费速率</span><br><span class="line">3. 提交失败率</span><br><span class="line">4. 重平衡频率</span><br><span class="line">5. 活跃消费者数</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/kafka%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="消费者组内的分区分配详解"><a href="#消费者组内的分区分配详解" class="headerlink" title="消费者组内的分区分配详解"></a>消费者组内的分区分配详解</h1><ol>
<li><p><strong>同组消费者分区分配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">场景一：单主题多分区</span><br><span class="line">Topic-A (3个分区)</span><br><span class="line">┌─────────────┐</span><br><span class="line">│ Partition 0 │────► Consumer1</span><br><span class="line">│ Partition 1 │────► Consumer2</span><br><span class="line">│ Partition 2 │────► Consumer1</span><br><span class="line">└─────────────┘</span><br><span class="line"></span><br><span class="line">Consumer Group X</span><br><span class="line">├── Consumer1: 消费Partition 0,2</span><br><span class="line">└── Consumer2: 消费Partition 1</span><br><span class="line"></span><br><span class="line">特点：</span><br><span class="line">- 每个消费者确实消费不同分区</span><br><span class="line">- 但这些分区的数据合起来是主题的全量数据</span><br><span class="line">- 消费者组作为整体可以看到主题的所有数据</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不同订阅的消费者能否在同组</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">场景二：订阅主题不同</span><br><span class="line">Consumer1订阅：Topic A,B,C</span><br><span class="line">Consumer2订阅：Topic A,B,C,D</span><br><span class="line"></span><br><span class="line">结论：不能在同一组！</span><br><span class="line">原因：</span><br><span class="line">1. 违反了消费者组的订阅原则</span><br><span class="line">2. 可能导致数据消费混乱</span><br><span class="line">3. Kafka会抛出异常</span><br><span class="line"></span><br><span class="line">正确做法：</span><br><span class="line">Consumer Group X</span><br><span class="line">├── Consumer1: 订阅 A,B,C,D</span><br><span class="line">└── Consumer2: 订阅 A,B,C,D</span><br><span class="line"></span><br><span class="line">或者分成不同组：</span><br><span class="line">Group1: Consumer1 (A,B,C)</span><br><span class="line">Group2: Consumer2 (A,B,C,D)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>实际案例说明</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误示例：同组不同订阅</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WrongGroupExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Consumer1</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer1 = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line">        consumer1.subscribe(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Consumer2 (同组但订阅不同)</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer2 = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line">        consumer2.subscribe(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 会导致异常！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确示例：同组相同订阅</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CorrectGroupExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 所有消费者订阅相同的主题</span></span><br><span class="line">        List&lt;String&gt; topics = Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Consumer1</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer1 = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line">        consumer1.subscribe(topics);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Consumer2</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer2 = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line">        consumer2.subscribe(topics);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>消费者组的数据完整性</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">示例场景：</span><br><span class="line">Topic-A (4个分区)</span><br><span class="line">┌─────────────┐</span><br><span class="line">│ Partition 0 │──┐</span><br><span class="line">│ Partition 1 │──┼─► Consumer Group X</span><br><span class="line">│ Partition 2 │──┤  ├── Consumer1</span><br><span class="line">│ Partition 3 │──┘  └── Consumer2</span><br><span class="line">└─────────────┘</span><br><span class="line"></span><br><span class="line">数据流：</span><br><span class="line">1. 生产者发送消息到各个分区</span><br><span class="line">2. 分区0,1 分配给Consumer1</span><br><span class="line">3. 分区2,3 分配给Consumer2</span><br><span class="line">4. 消费者组作为整体消费了所有数据</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>关键原则</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. 订阅原则</span><br><span class="line">   - 同组消费者必须订阅相同主题</span><br><span class="line">   - 违反会导致异常</span><br><span class="line"></span><br><span class="line">2. 分区分配</span><br><span class="line">   - 分区是最小分配单位</span><br><span class="line">   - 一个分区只能分配给一个消费者</span><br><span class="line">   - 消费者组能看到所有数据</span><br><span class="line"></span><br><span class="line">3. 扩展性</span><br><span class="line">   - 增加消费者可以提高并行度</span><br><span class="line">   - 消费者数不应超过分区总数</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/kafka%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/kafka%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka页面缓存工作原理"><a href="#Kafka页面缓存工作原理" class="headerlink" title="Kafka页面缓存工作原理"></a>Kafka页面缓存工作原理</h1><ol>
<li><p><strong>什么是页面缓存(Page Cache)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">操作系统的内存分层：</span><br><span class="line">┌────────────────────┐</span><br><span class="line">│    用户空间        │ &lt;- 应用程序（如JVM）使用</span><br><span class="line">├────────────────────┤</span><br><span class="line">│    页面缓存        │ &lt;- 操作系统管理的磁盘数据缓存</span><br><span class="line">│  (Page Cache)      │</span><br><span class="line">├────────────────────┤</span><br><span class="line">│    内核空间        │ &lt;- 系统内核使用</span><br><span class="line">└────────────────────┘</span><br><span class="line"></span><br><span class="line">特点：</span><br><span class="line">- 由操作系统管理</span><br><span class="line">- 用于缓存磁盘数据</span><br><span class="line">- 采用LRU算法</span><br><span class="line">- 支持预读和回写</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>传统JVM缓存的问题</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">数据读取流程（双重缓存）：</span><br><span class="line">磁盘 -&gt; 页面缓存 -&gt; JVM堆 -&gt; 应用程序</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">1. 数据被复制两次：</span><br><span class="line">   - 一次从磁盘到页面缓存</span><br><span class="line">   - 一次从页面缓存到JVM堆</span><br><span class="line">   </span><br><span class="line">2. 内存使用效率低：</span><br><span class="line">   - 相同数据占用两份内存空间</span><br><span class="line">   - JVM堆会触发GC</span><br><span class="line">   - GC会导致停顿</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kafka的页面缓存使用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Kafka读取流程：</span><br><span class="line">磁盘 -&gt; 页面缓存 -&gt; 应用程序（零拷贝）</span><br><span class="line"></span><br><span class="line">实现方式：</span><br><span class="line">1. sendfile系统调用：</span><br><span class="line">   - 直接从页面缓存传输到网络接口</span><br><span class="line">   - 避免数据复制到JVM堆</span><br><span class="line">   </span><br><span class="line">2. mmap内存映射：</span><br><span class="line">   - 将文件映射到内存地址空间</span><br><span class="line">   - 直接操作页面缓存</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能优势</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统方式</span></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;message.log&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">in.read(buffer); <span class="comment">// 数据复制到JVM堆</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Kafka方式（零拷贝）</span></span><br><span class="line"><span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;message.log&quot;</span>).getChannel();</span><br><span class="line">channel.transferTo(position, count, socketChannel); <span class="comment">// 直接传输</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>具体实现机制</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Kafka日志段读取代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileRecords</span> <span class="keyword">extends</span> <span class="title class_">AbstractRecords</span> &#123;</span><br><span class="line">    <span class="comment">// 使用MappedByteBuffer直接操作页面缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MappedByteBuffer mmap;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileRecords</span><span class="params">(File file, <span class="type">boolean</span> mmap)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mmap) &#123;</span><br><span class="line">            <span class="comment">// 内存映射方式</span></span><br><span class="line">            <span class="built_in">this</span>.mmap = Utils.mmap(file, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>优化效果</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">传统方式 vs Kafka方式：</span><br><span class="line"></span><br><span class="line">内存拷贝次数：</span><br><span class="line">- 传统：4次 (磁盘-&gt;内核-&gt;JVM堆-&gt;socket缓冲区-&gt;网卡)</span><br><span class="line">- Kafka：2次 (磁盘-&gt;页面缓存-&gt;网卡)</span><br><span class="line"></span><br><span class="line">上下文切换：</span><br><span class="line">- 传统：4次</span><br><span class="line">- Kafka：2次</span><br><span class="line"></span><br><span class="line">性能提升：</span><br><span class="line">- 吞吐量提高2-3倍</span><br><span class="line">- 延迟降低40-50%</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>最佳实践</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 预留足够的页面缓存空间</span></span><br><span class="line"><span class="comment"># 内存配置建议：</span></span><br><span class="line">系统内存 = JVM堆大小(4-8G) + 页面缓存(剩余内存)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 避免使用过大的JVM堆</span></span><br><span class="line"><span class="comment"># 配置示例：</span></span><br><span class="line"><span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">&quot;-Xms6g -Xmx6g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 监控页面缓存使用</span></span><br><span class="line">free -m</span><br><span class="line">vmstat 1</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/linux%E5%86%85%E5%AD%98%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/linux%E5%86%85%E5%AD%98%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Linux内存架构与页面缓存位置"><a href="#Linux内存架构与页面缓存位置" class="headerlink" title="Linux内存架构与页面缓存位置"></a>Linux内存架构与页面缓存位置</h1><ol>
<li><p><strong>Linux内存空间划分</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">系统内存布局：</span><br><span class="line">┌────────────────────┐</span><br><span class="line">│    用户空间        │ </span><br><span class="line">│  (User Space)      │ &lt;- 应用程序、JVM堆等</span><br><span class="line">│                    │    0 ~ 3G (32位系统)</span><br><span class="line">├────────────────────┤</span><br><span class="line">│    内核空间        │ &lt;- 内核代码、内核数据结构</span><br><span class="line">│  (Kernel Space)    │    页面缓存位于此处</span><br><span class="line">│                    │    3G ~ 4G (32位系统)</span><br><span class="line">└────────────────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>页面缓存的位置</strong></p>
</li>
</ol>
<ul>
<li>位于内核空间</li>
<li>由内核直接管理</li>
<li>对用户空间透明</li>
<li>通过系统调用访问</li>
</ul>
<ol start="3">
<li><p><strong>为什么在内核空间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">原因：</span><br><span class="line">1. 安全性：</span><br><span class="line">   - 防止用户程序直接修改缓存</span><br><span class="line">   - 保护系统关键数据</span><br><span class="line"></span><br><span class="line">2. 性能：</span><br><span class="line">   - 避免用户态和内核态切换</span><br><span class="line">   - 直接与磁盘I/O子系统交互</span><br><span class="line">   </span><br><span class="line">3. 统一管理：</span><br><span class="line">   - 集中管理所有进程的文件访问</span><br><span class="line">   - 优化整体系统性能</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>访问机制</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">应用程序访问文件数据流程：</span><br><span class="line"></span><br><span class="line">用户空间                    内核空间</span><br><span class="line">┌──────┐   系统调用   ┌───────────┐</span><br><span class="line">│ App  │ ==========&gt; │页面缓存    │</span><br><span class="line">└──────┘             └───────────┘</span><br><span class="line">                          ↕</span><br><span class="line">                     ┌───────────┐</span><br><span class="line">                     │  磁盘     │</span><br><span class="line">                     └───────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>内存映射(mmap)机制</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">使用mmap后：</span><br><span class="line"></span><br><span class="line">用户空间                    内核空间</span><br><span class="line">┌──────┐   映射   ┌───────────┐</span><br><span class="line">│ App  │ &lt;======&gt; │页面缓存    │</span><br><span class="line">└──────┘         └───────────┘</span><br><span class="line"></span><br><span class="line">特点：</span><br><span class="line">- 在用户空间直接映射内核的页面缓存</span><br><span class="line">- 避免了数据复制</span><br><span class="line">- 仍然由内核管理</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/redis_lua%E9%99%90%E6%B5%81%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/redis_lua%E9%99%90%E6%B5%81%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis-Lua分布式限流实现"><a href="#Redis-Lua分布式限流实现" class="headerlink" title="Redis+Lua分布式限流实现"></a>Redis+Lua分布式限流实现</h1><ol>
<li><p><strong>基本架构</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">请求流转图：</span><br><span class="line">┌──────────┐    1.请求     ┌──────────┐</span><br><span class="line">│ Client 1 │─────────────►│          │</span><br><span class="line">└──────────┘              │          │</span><br><span class="line">┌──────────┐    2.限流    │   API    │</span><br><span class="line">│ Client 2 │◄────────────►│ Gateway  │</span><br><span class="line">└──────────┘              │          │</span><br><span class="line">┌──────────┐    3.计数    │          │</span><br><span class="line">│ Client 3 │─────────────►│          │</span><br><span class="line">└──────────┘              └────┬─────┘</span><br><span class="line">                              │</span><br><span class="line">                         4.执行Lua脚本</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">                        ┌──────────┐</span><br><span class="line">                        │  Redis   │</span><br><span class="line">                        └──────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Lua限流脚本</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 限流脚本</span></span><br><span class="line"><span class="comment">-- KEYS[1]: 限流key</span></span><br><span class="line"><span class="comment">-- ARGV[1]: 时间窗口大小(秒)</span></span><br><span class="line"><span class="comment">-- ARGV[2]: 限流阈值</span></span><br><span class="line"><span class="comment">-- ARGV[3]: 当前时间戳</span></span><br><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> window = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> threshold = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">local</span> now = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1. 移除时间窗口之前的数据</span></span><br><span class="line">redis.call(<span class="string">&#x27;ZREMRANGEBYSCORE&#x27;</span>, key, <span class="number">0</span>, now - window * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 获取当前窗口的请求数</span></span><br><span class="line"><span class="keyword">local</span> count = redis.call(<span class="string">&#x27;ZCARD&#x27;</span>, key)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 判断是否超过阈值</span></span><br><span class="line"><span class="keyword">if</span> count &gt;= threshold <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 记录本次请求</span></span><br><span class="line">redis.call(<span class="string">&#x27;ZADD&#x27;</span>, key, now, now)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 设置过期时间</span></span><br><span class="line">redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, key, window)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Java实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String luaScript;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisLimiter</span><span class="params">(StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        <span class="comment">// 加载Lua脚本</span></span><br><span class="line">        <span class="built_in">this</span>.luaScript = loadLuaScript();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAllowed</span><span class="params">(String key, <span class="type">int</span> window, <span class="type">int</span> threshold)</span> &#123;</span><br><span class="line">        List&lt;String&gt; keys = Collections.singletonList(key);</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行Lua脚本</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(luaScript, Long.class),</span><br><span class="line">            keys,</span><br><span class="line">            String.valueOf(window),</span><br><span class="line">            String.valueOf(threshold),</span><br><span class="line">            String.valueOf(now)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result != <span class="literal">null</span> &amp;&amp; result == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>动态调整实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicRateLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIMIT_CONFIG_KEY</span> <span class="operator">=</span> <span class="string">&quot;rate:limit:config&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新限流阈值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateThreshold</span><span class="params">(String key, <span class="type">int</span> threshold)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().put(</span><br><span class="line">            LIMIT_CONFIG_KEY, </span><br><span class="line">            key, </span><br><span class="line">            String.valueOf(threshold)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getCurrentThreshold</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String) redisTemplate.opsForHash()</span><br><span class="line">            .get(LIMIT_CONFIG_KEY, key);</span><br><span class="line">        <span class="keyword">return</span> value == <span class="literal">null</span> ? </span><br><span class="line">            defaultThreshold : Integer.parseInt(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 限流检查</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAllowed</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">threshold</span> <span class="operator">=</span> getCurrentThreshold(key);</span><br><span class="line">        <span class="keyword">return</span> redisLimiter.isAllowed(</span><br><span class="line">            key, </span><br><span class="line">            window, </span><br><span class="line">            threshold</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>滑动时间窗口示意</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">时间窗口滑动：</span><br><span class="line">     now-60s          now</span><br><span class="line">        │             │</span><br><span class="line">        ▼             ▼</span><br><span class="line">┌─────────────────────┐</span><br><span class="line">│   时间窗口(60s)     │</span><br><span class="line">└─────────────────────┘</span><br><span class="line">        │             │</span><br><span class="line">        │  ┌──────┐   │</span><br><span class="line">        │  │请求量│   │</span><br><span class="line">        │  └──────┘   │</span><br><span class="line">        │             │</span><br><span class="line">  过期的请求    新请求</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicRateLimiter limiter;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;api:test&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!limiter.isAllowed(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;请求被限流&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 业务逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/limit/update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateLimit</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam</span> String key, </span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam</span> <span class="type">int</span> threshold</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        limiter.updateThreshold(key, threshold);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/seata_at%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/seata_at%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Seata-AT模式详解"><a href="#Seata-AT模式详解" class="headerlink" title="Seata AT模式详解"></a>Seata AT模式详解</h1><ol>
<li><p><strong>AT模式原理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">执行流程：</span><br><span class="line">┌─────────────┐     ┌─────────────┐     ┌─────────────┐</span><br><span class="line">│   业务SQL    │     │   解析SQL   │     │  生成回滚SQL │</span><br><span class="line">└──────┬──────┘     └──────┬──────┘     └──────┬──────┘</span><br><span class="line">       │                   │                   │</span><br><span class="line">       ▼                   ▼                   ▼</span><br><span class="line">┌─────────────┐     ┌─────────────┐     ┌─────────────┐</span><br><span class="line">│ 记录前镜像   │ ──► │  执行业务SQL │ ──► │ 记录后镜像   │</span><br><span class="line">└─────────────┘     └─────────────┘     └─────────────┘</span><br><span class="line"></span><br><span class="line">两阶段提交：</span><br><span class="line">Phase 1: Try</span><br><span class="line">- 业务SQL执行</span><br><span class="line">- 解析SQL</span><br><span class="line">- 记录前后镜像</span><br><span class="line">- 生成回滚日志</span><br><span class="line"></span><br><span class="line">Phase 2: Commit/Rollback</span><br><span class="line">- Commit: 删除回滚日志</span><br><span class="line">- Rollback: 根据镜像生成反向SQL</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>核心组件</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 数据源代理</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    <span class="comment">// 配置数据源</span></span><br><span class="line">    dataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用Seata代理数据源</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProxy</span>(dataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 全局事务注解</span></span><br><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">businessMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 订单服务</span></span><br><span class="line">    orderService.create(order);</span><br><span class="line">    <span class="comment">// 库存服务</span></span><br><span class="line">    stockService.deduct(stock);</span><br><span class="line">    <span class="comment">// 账户服务</span></span><br><span class="line">    accountService.debit(money);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>实际应用场景</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">场景一：电商下单</span><br><span class="line">┌─────────────┐</span><br><span class="line">│  下单服务   │</span><br><span class="line">└──────┬──────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌──────┴──────┐     ┌─────────────┐     ┌─────────────┐</span><br><span class="line">│  订单服务   │ ──► │  库存服务   │ ──► │  账户服务   │</span><br><span class="line">└─────────────┘     └─────────────┘     └─────────────┘</span><br><span class="line">订单表         库存表         账户表</span><br><span class="line">- 创建订单     - 扣减库存     - 扣减余额</span><br><span class="line"></span><br><span class="line">场景二：积分兑换</span><br><span class="line">┌─────────────┐</span><br><span class="line">│  兑换服务   │</span><br><span class="line">└──────┬──────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌──────┴──────┐     ┌─────────────┐</span><br><span class="line">│  积分服务   │ ──► │  商品服务   │</span><br><span class="line">└─────────────┘     └─────────────┘</span><br><span class="line">积分表         库存表</span><br><span class="line">- 扣减积分     - 扣减库存</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>实现示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单服务</span></span><br><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createOrder</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 创建订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setUserId(orderDTO.getUserId());</span><br><span class="line">    order.setAmount(orderDTO.getAmount());</span><br><span class="line">    orderMapper.insert(order);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 调用库存服务</span></span><br><span class="line">    <span class="type">Result</span> <span class="variable">stockResult</span> <span class="operator">=</span> stockService.deduct(</span><br><span class="line">        orderDTO.getProductId(), </span><br><span class="line">        orderDTO.getQuantity()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!stockResult.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 调用账户服务</span></span><br><span class="line">    <span class="type">Result</span> <span class="variable">accountResult</span> <span class="operator">=</span> accountService.debit(</span><br><span class="line">        orderDTO.getUserId(), </span><br><span class="line">        orderDTO.getAmount()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!accountResult.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>优缺点分析</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">优点：</span><br><span class="line">1. 对业务无侵入</span><br><span class="line">2. 无需手动编写回滚逻辑</span><br><span class="line">3. 性能损耗小</span><br><span class="line">4. 兼容已有数据库</span><br><span class="line"></span><br><span class="line">缺点：</span><br><span class="line">1. 依赖数据库事务</span><br><span class="line">2. 需要代理数据源</span><br><span class="line">3. 无法处理复杂业务</span><br><span class="line">4. 表需要主键和索引</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用建议</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">适用场景：</span><br><span class="line">1. 简单的数据库操作</span><br><span class="line">2. 常规的CRUD业务</span><br><span class="line">3. 对性能要求不是特别高</span><br><span class="line">4. 数据库支持事务</span><br><span class="line"></span><br><span class="line">不适用场景：</span><br><span class="line">1. 复杂业务逻辑</span><br><span class="line">2. 高并发场景</span><br><span class="line">3. 涉及非事务性资源</span><br><span class="line">4. 跨数据库类型</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能优化</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> GlobalTransactionScanner <span class="title function_">globalTransactionScanner</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GlobalTransactionScanner</span>(</span><br><span class="line">            <span class="string">&quot;order-service&quot;</span>,  <span class="comment">// 应用名</span></span><br><span class="line">            <span class="string">&quot;my_test_tx_group&quot;</span>  <span class="comment">// 事务分组</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置事务分组</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConfigurationCache <span class="title function_">configurationCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ConfigurationCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationCache</span>();</span><br><span class="line">        cache.putConfig(</span><br><span class="line">            <span class="string">&quot;service.vgroupMapping.my_test_tx_group&quot;</span>,</span><br><span class="line">            <span class="string">&quot;default&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/easyexcel%E4%B8%8A%E4%B8%8B%E6%96%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/easyexcel%E4%B8%8A%E4%B8%8B%E6%96%87/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CellWriteHandlerContext上下文信息获取"><a href="#CellWriteHandlerContext上下文信息获取" class="headerlink" title="CellWriteHandlerContext上下文信息获取"></a>CellWriteHandlerContext上下文信息获取</h1><ol>
<li><p><strong>获取总行数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaCellWriteHandler</span> <span class="keyword">implements</span> <span class="title class_">CellWriteHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCellDispose</span><span class="params">(CellWriteHandlerContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前sheet</span></span><br><span class="line">        <span class="type">WriteSheetHolder</span> <span class="variable">writeSheetHolder</span> <span class="operator">=</span> context.getWriteSheetHolder();</span><br><span class="line">        <span class="comment">// 获取当前sheet的总行数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">totalRows</span> <span class="operator">=</span> writeSheetHolder.getSheet().getLastRowNum();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> context.getCell();</span><br><span class="line">        <span class="comment">// 判断是否是最后一行的第三列(C列)</span></span><br><span class="line">        <span class="keyword">if</span> (cell.getRowIndex() == totalRows &amp;&amp; cell.getColumnIndex() == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置求和公式，从第2行开始到最后一行</span></span><br><span class="line">            cell.setCellFormula(<span class="string">&quot;SUM(C2:C&quot;</span> + totalRows + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>上下文中可获取的信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 行相关</span></span><br><span class="line">context.getRow();                    <span class="comment">// 当前行</span></span><br><span class="line">context.getRowIndex();              <span class="comment">// 当前行号</span></span><br><span class="line">context.getRelativeRowIndex();      <span class="comment">// 相对行号(不包括表头)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 列相关</span></span><br><span class="line">context.getCell();                  <span class="comment">// 当前单元格</span></span><br><span class="line">context.getColumnIndex();           <span class="comment">// 当前列号</span></span><br><span class="line">context.getHead();                  <span class="comment">// 表头信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Sheet相关</span></span><br><span class="line">context.getWriteSheetHolder();      <span class="comment">// Sheet相关信息</span></span><br><span class="line">context.getWriteTableHolder();      <span class="comment">// Table相关信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 工作簿相关</span></span><br><span class="line">context.getWriteWorkbookHolder();   <span class="comment">// 工作簿相关信息</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>实际应用示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaCellWriteHandler</span> <span class="keyword">implements</span> <span class="title class_">CellWriteHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCellDispose</span><span class="params">(CellWriteHandlerContext context)</span> &#123;</span><br><span class="line">        <span class="type">WriteSheetHolder</span> <span class="variable">writeSheetHolder</span> <span class="operator">=</span> context.getWriteSheetHolder();</span><br><span class="line">        <span class="type">Sheet</span> <span class="variable">sheet</span> <span class="operator">=</span> writeSheetHolder.getSheet();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 当前行号</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">currentRowIndex</span> <span class="operator">=</span> context.getRowIndex();</span><br><span class="line">        <span class="comment">// 总行数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">totalRows</span> <span class="operator">=</span> sheet.getLastRowNum();</span><br><span class="line">        <span class="comment">// 当前列号</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">columnIndex</span> <span class="operator">=</span> context.getColumnIndex();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断是否是最后一行的金额列</span></span><br><span class="line">        <span class="keyword">if</span> (currentRowIndex == totalRows &amp;&amp; columnIndex == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> context.getCell();</span><br><span class="line">            <span class="comment">// 设置公式</span></span><br><span class="line">            cell.setCellFormula(<span class="string">&quot;SUM(C2:C&quot;</span> + totalRows + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置样式</span></span><br><span class="line">            <span class="type">CellStyle</span> <span class="variable">style</span> <span class="operator">=</span> context.getWriteWorkbookHolder().getWorkbook().createCellStyle();</span><br><span class="line">            style.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());</span><br><span class="line">            style.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">            cell.setCellStyle(style);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注意事项</strong></p>
</li>
</ol>
<ul>
<li>getLastRowNum()返回的是最后一行的索引（从0开始）</li>
<li>需要考虑表头行的影响</li>
<li>相对行号不包括表头行</li>
<li>可以通过上下文获取完整的写入信息</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/04/24/easyexcel%E5%87%BD%E6%95%B0%E5%86%99%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/24/easyexcel%E5%87%BD%E6%95%B0%E5%86%99%E5%85%A5/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-04-24 19:39:57" itemprop="dateCreated datePublished" datetime="2025-04-24T19:39:57+08:00">2025-04-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="EasyExcel写入Excel函数"><a href="#EasyExcel写入Excel函数" class="headerlink" title="EasyExcel写入Excel函数"></a>EasyExcel写入Excel函数</h1><ol>
<li><p><strong>基本实现方案</strong>(<a target="_blank" rel="noopener" href="https://easyexcel.opensource.alibaba.com/docs/current/">1</a>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeWithFormula</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;测试公式.xlsx&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ExcelWriter</span> <span class="variable">excelWriter</span> <span class="operator">=</span> EasyExcel.write(fileName, DemoData.class).build()) &#123;</span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">writeSheet</span> <span class="operator">=</span> EasyExcel.writerSheet(<span class="string">&quot;模板&quot;</span>).build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 写入正常数据</span></span><br><span class="line">        List&lt;DemoData&gt; dataList = getData();</span><br><span class="line">        excelWriter.write(dataList, writeSheet);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 写入公式行</span></span><br><span class="line">        <span class="comment">// 假设金额在第3列，数据从第2行开始(第1行是表头)</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lastRow</span> <span class="operator">=</span> dataList.size() + <span class="number">1</span>;  <span class="comment">// 最后一行的位置</span></span><br><span class="line">        List&lt;List&lt;Object&gt;&gt; formulaRowList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Object&gt; formulaRow = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        formulaRow.add(<span class="string">&quot;合计&quot;</span>);  <span class="comment">// 第1列</span></span><br><span class="line">        formulaRow.add(<span class="literal">null</span>);   <span class="comment">// 第2列</span></span><br><span class="line">        <span class="comment">// 第3列写入SUM函数，计算从第2行到最后一行的和</span></span><br><span class="line">        formulaRow.add(<span class="keyword">new</span> <span class="title class_">FormulaData</span>(<span class="string">&quot;SUM(C2:C&quot;</span> + lastRow + <span class="string">&quot;)&quot;</span>));</span><br><span class="line">        formulaRowList.add(formulaRow);</span><br><span class="line">        </span><br><span class="line">        excelWriter.write(formulaRowList, writeSheet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FormulaData类用于包装公式</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String formula;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FormulaData</span><span class="params">(String formula)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.formula = formula;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用CellWriteHandler实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaCellWriteHandler</span> <span class="keyword">implements</span> <span class="title class_">CellWriteHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCellDispose</span><span class="params">(CellWriteHandlerContext context)</span> &#123;</span><br><span class="line">        <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> context.getCell();</span><br><span class="line">        <span class="comment">// 判断是否是最后一行的第三列</span></span><br><span class="line">        <span class="keyword">if</span> (cell.getRowIndex() == context.getWriteSheetHolder().getSheetNo() </span><br><span class="line">            &amp;&amp; cell.getColumnIndex() == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置公式</span></span><br><span class="line">            cell.setCellFormula(<span class="string">&quot;SUM(C2:C&quot;</span> + (cell.getRowIndex()) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>支持的常用Excel函数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求和函数</span></span><br><span class="line"><span class="string">&quot;SUM(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 平均值函数</span></span><br><span class="line"><span class="string">&quot;AVERAGE(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最大值函数</span></span><br><span class="line"><span class="string">&quot;MAX(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最小值函数</span></span><br><span class="line"><span class="string">&quot;MIN(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计数函数</span></span><br><span class="line"><span class="string">&quot;COUNT(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IF条件函数</span></span><br><span class="line"><span class="string">&quot;IF(C2&gt;100,\&quot;高\&quot;,\&quot;低\&quot;)&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注意事项</strong></p>
</li>
</ol>
<ul>
<li>函数单元格需要使用FormulaData包装</li>
<li>函数引用的单元格范围要准确</li>
<li>注意行列的索引从0开始</li>
<li>可以使用相对引用和绝对引用</li>
<li>复杂函数建议使用CellWriteHandler实现</li>
</ul>
<h1 id="EasyExcel写入公式完整示例"><a href="#EasyExcel写入公式完整示例" class="headerlink" title="EasyExcel写入公式完整示例"></a>EasyExcel写入公式完整示例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeWithFormula</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;测试公式.xlsx&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关键点：在这里注册CellWriteHandler</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ExcelWriter</span> <span class="variable">excelWriter</span> <span class="operator">=</span> EasyExcel.write(fileName, DemoData.class)</span><br><span class="line">            .registerWriteHandler(<span class="keyword">new</span> <span class="title class_">FormulaCellWriteHandler</span>())  <span class="comment">// 注册处理器</span></span><br><span class="line">            .build()) &#123;</span><br><span class="line">            </span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">writeSheet</span> <span class="operator">=</span> EasyExcel.writerSheet(<span class="string">&quot;模板&quot;</span>).build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入数据</span></span><br><span class="line">        List&lt;DemoData&gt; dataList = getData();</span><br><span class="line">        excelWriter.write(dataList, writeSheet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理器实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaCellWriteHandler</span> <span class="keyword">implements</span> <span class="title class_">CellWriteHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCellDispose</span><span class="params">(CellWriteHandlerContext context)</span> &#123;</span><br><span class="line">        <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> context.getCell();</span><br><span class="line">        <span class="comment">// 判断是否是最后一行的第三列</span></span><br><span class="line">        <span class="keyword">if</span> (cell.getRowIndex() == context.getWriteSheetHolder().getSheetNo() </span><br><span class="line">            &amp;&amp; cell.getColumnIndex() == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置公式</span></span><br><span class="line">            cell.setCellFormula(<span class="string">&quot;SUM(C2:C&quot;</span> + (cell.getRowIndex()) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据对象</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键点说明：</p>
<ol>
<li>使用<code>.registerWriteHandler()</code>注册处理器</li>
<li>处理器会在每个单元格写入时被调用</li>
<li>不需要单独写入最后一行，处理器会自动处理</li>
<li>相比之前的方案更加简洁和自动化</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">true</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
