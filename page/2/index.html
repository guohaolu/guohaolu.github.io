<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"guohaolu.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12,"visitor":true,"social":true,"categories":true,"tags":true,"toc":{"enable":true,"number":true,"wrap":true}},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="分享技术，记录生活">
<meta property="og:type" content="website">
<meta property="og:title" content="Guohao Lu&#39;s Blog">
<meta property="og:url" content="https://guohaolu.github.io/page/2/index.html">
<meta property="og:site_name" content="Guohao Lu&#39;s Blog">
<meta property="og:description" content="分享技术，记录生活">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="guohao.lu">
<meta property="article:tag" content="技术,博客,编程">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://guohaolu.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Guohao Lu's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Guohao Lu's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">个人技术博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">guohao.lu</p>
  <div class="site-description" itemprop="description">分享技术，记录生活</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/guohaolu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;guohaolu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1670212878@qq.com" title="E-Mail → mailto:1670212878@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/easyexcel%E5%87%BD%E6%95%B0%E5%86%99%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/easyexcel%E5%87%BD%E6%95%B0%E5%86%99%E5%85%A5/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="EasyExcel写入Excel函数"><a href="#EasyExcel写入Excel函数" class="headerlink" title="EasyExcel写入Excel函数"></a>EasyExcel写入Excel函数</h1><ol>
<li><p><strong>基本实现方案</strong>(<a target="_blank" rel="noopener" href="https://easyexcel.opensource.alibaba.com/docs/current/">1</a>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeWithFormula</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;测试公式.xlsx&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ExcelWriter</span> <span class="variable">excelWriter</span> <span class="operator">=</span> EasyExcel.write(fileName, DemoData.class).build()) &#123;</span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">writeSheet</span> <span class="operator">=</span> EasyExcel.writerSheet(<span class="string">&quot;模板&quot;</span>).build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 写入正常数据</span></span><br><span class="line">        List&lt;DemoData&gt; dataList = getData();</span><br><span class="line">        excelWriter.write(dataList, writeSheet);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 写入公式行</span></span><br><span class="line">        <span class="comment">// 假设金额在第3列，数据从第2行开始(第1行是表头)</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lastRow</span> <span class="operator">=</span> dataList.size() + <span class="number">1</span>;  <span class="comment">// 最后一行的位置</span></span><br><span class="line">        List&lt;List&lt;Object&gt;&gt; formulaRowList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Object&gt; formulaRow = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        formulaRow.add(<span class="string">&quot;合计&quot;</span>);  <span class="comment">// 第1列</span></span><br><span class="line">        formulaRow.add(<span class="literal">null</span>);   <span class="comment">// 第2列</span></span><br><span class="line">        <span class="comment">// 第3列写入SUM函数，计算从第2行到最后一行的和</span></span><br><span class="line">        formulaRow.add(<span class="keyword">new</span> <span class="title class_">FormulaData</span>(<span class="string">&quot;SUM(C2:C&quot;</span> + lastRow + <span class="string">&quot;)&quot;</span>));</span><br><span class="line">        formulaRowList.add(formulaRow);</span><br><span class="line">        </span><br><span class="line">        excelWriter.write(formulaRowList, writeSheet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FormulaData类用于包装公式</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String formula;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FormulaData</span><span class="params">(String formula)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.formula = formula;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用CellWriteHandler实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaCellWriteHandler</span> <span class="keyword">implements</span> <span class="title class_">CellWriteHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCellDispose</span><span class="params">(CellWriteHandlerContext context)</span> &#123;</span><br><span class="line">        <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> context.getCell();</span><br><span class="line">        <span class="comment">// 判断是否是最后一行的第三列</span></span><br><span class="line">        <span class="keyword">if</span> (cell.getRowIndex() == context.getWriteSheetHolder().getSheetNo() </span><br><span class="line">            &amp;&amp; cell.getColumnIndex() == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置公式</span></span><br><span class="line">            cell.setCellFormula(<span class="string">&quot;SUM(C2:C&quot;</span> + (cell.getRowIndex()) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>支持的常用Excel函数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求和函数</span></span><br><span class="line"><span class="string">&quot;SUM(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 平均值函数</span></span><br><span class="line"><span class="string">&quot;AVERAGE(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最大值函数</span></span><br><span class="line"><span class="string">&quot;MAX(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最小值函数</span></span><br><span class="line"><span class="string">&quot;MIN(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计数函数</span></span><br><span class="line"><span class="string">&quot;COUNT(C2:C10)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IF条件函数</span></span><br><span class="line"><span class="string">&quot;IF(C2&gt;100,\&quot;高\&quot;,\&quot;低\&quot;)&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注意事项</strong></p>
</li>
</ol>
<ul>
<li>函数单元格需要使用FormulaData包装</li>
<li>函数引用的单元格范围要准确</li>
<li>注意行列的索引从0开始</li>
<li>可以使用相对引用和绝对引用</li>
<li>复杂函数建议使用CellWriteHandler实现</li>
</ul>
<h1 id="EasyExcel写入公式完整示例"><a href="#EasyExcel写入公式完整示例" class="headerlink" title="EasyExcel写入公式完整示例"></a>EasyExcel写入公式完整示例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeWithFormula</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;测试公式.xlsx&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关键点：在这里注册CellWriteHandler</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ExcelWriter</span> <span class="variable">excelWriter</span> <span class="operator">=</span> EasyExcel.write(fileName, DemoData.class)</span><br><span class="line">            .registerWriteHandler(<span class="keyword">new</span> <span class="title class_">FormulaCellWriteHandler</span>())  <span class="comment">// 注册处理器</span></span><br><span class="line">            .build()) &#123;</span><br><span class="line">            </span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">writeSheet</span> <span class="operator">=</span> EasyExcel.writerSheet(<span class="string">&quot;模板&quot;</span>).build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入数据</span></span><br><span class="line">        List&lt;DemoData&gt; dataList = getData();</span><br><span class="line">        excelWriter.write(dataList, writeSheet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理器实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormulaCellWriteHandler</span> <span class="keyword">implements</span> <span class="title class_">CellWriteHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCellDispose</span><span class="params">(CellWriteHandlerContext context)</span> &#123;</span><br><span class="line">        <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> context.getCell();</span><br><span class="line">        <span class="comment">// 判断是否是最后一行的第三列</span></span><br><span class="line">        <span class="keyword">if</span> (cell.getRowIndex() == context.getWriteSheetHolder().getSheetNo() </span><br><span class="line">            &amp;&amp; cell.getColumnIndex() == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置公式</span></span><br><span class="line">            cell.setCellFormula(<span class="string">&quot;SUM(C2:C&quot;</span> + (cell.getRowIndex()) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据对象</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键点说明：</p>
<ol>
<li>使用<code>.registerWriteHandler()</code>注册处理器</li>
<li>处理器会在每个单元格写入时被调用</li>
<li>不需要单独写入最后一行，处理器会自动处理</li>
<li>相比之前的方案更加简洁和自动化</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/easyexcel%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/easyexcel%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="EasyExcel导出并在最后插入汇总行"><a href="#EasyExcel导出并在最后插入汇总行" class="headerlink" title="EasyExcel导出并在最后插入汇总行"></a>EasyExcel导出并在最后插入汇总行</h1><ol>
<li><p><strong>实现方案</strong>(<a target="_blank" rel="noopener" href="https://easyexcel.opensource.alibaba.com/docs/current/">1</a>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeWithLastRow</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;测试导出.xlsx&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用ExcelWriter可以实现更灵活的写入</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ExcelWriter</span> <span class="variable">excelWriter</span> <span class="operator">=</span> EasyExcel.write(fileName, DemoData.class).build()) &#123;</span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">writeSheet</span> <span class="operator">=</span> EasyExcel.writerSheet(<span class="string">&quot;sheet1&quot;</span>).build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 先写入正常的数据列表</span></span><br><span class="line">        List&lt;DemoData&gt; dataList = getData();</span><br><span class="line">        excelWriter.write(dataList, writeSheet);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 创建最后一行的汇总数据</span></span><br><span class="line">        List&lt;List&lt;String&gt;&gt; lastRowList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; lastRow = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        lastRow.add(<span class="string">&quot;合计&quot;</span>);  <span class="comment">// 第一列</span></span><br><span class="line">        lastRow.add(<span class="string">&quot;100&quot;</span>);   <span class="comment">// 第二列</span></span><br><span class="line">        lastRow.add(<span class="string">&quot;200&quot;</span>);   <span class="comment">// 第三列</span></span><br><span class="line">        lastRowList.add(lastRow);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 写入最后一行</span></span><br><span class="line">        excelWriter.write(lastRowList, writeSheet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>进阶实现：添加样式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LastRowWriteHandler</span> <span class="keyword">implements</span> <span class="title class_">RowWriteHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> totalRows;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LastRowWriteHandler</span><span class="params">(<span class="type">int</span> totalRows)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.totalRows = totalRows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterRowDispose</span><span class="params">(RowWriteHandlerContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断是否是最后一行</span></span><br><span class="line">        <span class="keyword">if</span> (context.getRow().getRowNum() == totalRows) &#123;</span><br><span class="line">            <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> context.getRow();</span><br><span class="line">            <span class="type">CellStyle</span> <span class="variable">style</span> <span class="operator">=</span> context.getWriteWorkbookHolder().getWorkbook().createCellStyle();</span><br><span class="line">            <span class="comment">// 设置背景色为灰色</span></span><br><span class="line">            style.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());</span><br><span class="line">            style.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">            <span class="comment">// 设置字体加粗</span></span><br><span class="line">            <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> context.getWriteWorkbookHolder().getWorkbook().createFont();</span><br><span class="line">            font.setBold(<span class="literal">true</span>);</span><br><span class="line">            style.setFont(font);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 为最后一行的每个单元格设置样式</span></span><br><span class="line">            <span class="keyword">for</span> (Cell cell : row) &#123;</span><br><span class="line">                cell.setCellStyle(style);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>完整示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeWithStyledLastRow</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;测试导出.xlsx&quot;</span>;</span><br><span class="line">    List&lt;DemoData&gt; dataList = getData();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ExcelWriter</span> <span class="variable">excelWriter</span> <span class="operator">=</span> EasyExcel.write(fileName, DemoData.class)</span><br><span class="line">            .registerWriteHandler(<span class="keyword">new</span> <span class="title class_">LastRowWriteHandler</span>(dataList.size() + <span class="number">1</span>))  <span class="comment">// +1是因为有表头</span></span><br><span class="line">            .build()) &#123;</span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">writeSheet</span> <span class="operator">=</span> EasyExcel.writerSheet(<span class="string">&quot;sheet1&quot;</span>).build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入数据</span></span><br><span class="line">        excelWriter.write(dataList, writeSheet);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入汇总行</span></span><br><span class="line">        List&lt;List&lt;String&gt;&gt; lastRowList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; lastRow = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        lastRow.add(<span class="string">&quot;合计&quot;</span>);</span><br><span class="line">        lastRow.add(calculateTotal(dataList));  <span class="comment">// 计算汇总值</span></span><br><span class="line">        lastRowList.add(lastRow);</span><br><span class="line">        </span><br><span class="line">        excelWriter.write(lastRowList, writeSheet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算汇总值的辅助方法</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">calculateTotal</span><span class="params">(List&lt;DemoData&gt; dataList)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> dataList.stream()</span><br><span class="line">            .map(DemoData::getAmount)</span><br><span class="line">            .reduce(BigDecimal.ZERO, BigDecimal::add)</span><br><span class="line">            .toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注意事项</strong></p>
</li>
</ol>
<ul>
<li>需要使用ExcelWriter而不是简单的doWrite方法</li>
<li>最后一行数据需要单独构造List&lt;List<String>&gt;格式</li>
<li>可以通过RowWriteHandler自定义最后一行样式</li>
<li>注意关闭ExcelWriter资源</li>
<li>如果有合并单元格需求，可以使用CellWriteHandler</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka_isr_osr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka_isr_osr/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka的ISR和OSR机制"><a href="#Kafka的ISR和OSR机制" class="headerlink" title="Kafka的ISR和OSR机制"></a>Kafka的ISR和OSR机制</h1><ol>
<li><p><strong>基本概念</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AR (Assigned Replicas): 所有副本</span><br><span class="line">ISR (In-Sync Replicas): 同步副本集合</span><br><span class="line">OSR (Out-of-Sync Replicas): 非同步副本集合</span><br><span class="line"></span><br><span class="line">关系：AR = ISR + OSR</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ISR(In-Sync Replicas)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">特点：</span><br><span class="line">- 与leader保持同步的follower集合</span><br><span class="line">- 包含leader副本自身</span><br><span class="line">- 动态调整：follower可能进入或退出ISR</span><br><span class="line"></span><br><span class="line">判断标准：</span><br><span class="line">1. replica.lag.time.max.ms内有同步请求</span><br><span class="line">2. 副本落后leader的消息数不超过replica.lag.max.messages</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>OSR(Out-of-Sync Replicas)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">特点：</span><br><span class="line">- 与leader副本同步滞后的follower集合</span><br><span class="line">- 暂时无法参与副本选举</span><br><span class="line">- 会尝试追赶leader数据</span><br><span class="line"></span><br><span class="line">产生原因：</span><br><span class="line">1. 网络延迟或阻塞</span><br><span class="line">2. follower所在broker负载过高</span><br><span class="line">3. follower崩溃或重启</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>动态维护机制</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码展示ISR维护逻辑</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Partition</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">checkISRUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 检查follower延迟</span></span><br><span class="line">        <span class="keyword">for</span> (Replica follower : AR) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inISR(follower)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isLagging(follower)) &#123;</span><br><span class="line">                    moveToOSR(follower);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!isLagging(follower)) &#123;</span><br><span class="line">                    moveToISR(follower);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 持久化ISR变更</span></span><br><span class="line">        <span class="keyword">if</span> (isrChanged) &#123;</span><br><span class="line">            updateZkIsrChange();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>与可用性的关系</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">acks配置影响：</span><br><span class="line"></span><br><span class="line">acks=all (-1)：</span><br><span class="line">- 等待ISR中所有副本确认</span><br><span class="line">- 最高可靠性</span><br><span class="line">- 较低吞吐量</span><br><span class="line"></span><br><span class="line">acks=1：</span><br><span class="line">- 仅等待leader确认</span><br><span class="line">- 中等可靠性</span><br><span class="line">- 中等吞吐量</span><br><span class="line"></span><br><span class="line">acks=0：</span><br><span class="line">- 不等待确认</span><br><span class="line">- 最低可靠性</span><br><span class="line">- 最高吞吐量</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>监控指标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">关键监控项：</span><br><span class="line">1. UnderReplicatedPartitions</span><br><span class="line">   - 表示副本同步滞后的分区数</span><br><span class="line">   - 反映系统健康状况</span><br><span class="line"></span><br><span class="line">2. IsrExpandsPerSec/IsrShrinksPerSec</span><br><span class="line">   - ISR集合扩大/收缩的频率</span><br><span class="line">   - 反映系统稳定性</span><br><span class="line"></span><br><span class="line">3. ReplicaMaxLag</span><br><span class="line">   - follower落后leader的最大消息数</span><br><span class="line">   - 反映副本同步状况</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka_rebalance%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka_rebalance%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka-Rebalance协议详解"><a href="#Kafka-Rebalance协议详解" class="headerlink" title="Kafka Rebalance协议详解"></a>Kafka Rebalance协议详解</h1><ol>
<li><p><strong>核心角色</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">参与者：</span><br><span class="line">┌─────────────────┐    ┌─────────────────┐</span><br><span class="line">│  Group          │    │     Consumer    │</span><br><span class="line">│  Coordinator    │    │     Group       │</span><br><span class="line">│  (协调者)        │    │     (消费组)    │</span><br><span class="line">└─────────────────┘    └─────────────────┘</span><br><span class="line"></span><br><span class="line">- Coordinator：负责管理消费组的组件，运行在Broker上</span><br><span class="line">- Consumer Group：消费者组的所有成员</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Join Group阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">步骤1：所有消费者向Coordinator发送JoinGroup请求</span><br><span class="line">┌─────────┐         ┌──────────┐</span><br><span class="line">│Consumer1│─────┐   │          │</span><br><span class="line">└─────────┘     │   │          │</span><br><span class="line">┌─────────┐     ├──&gt;│Coordinator</span><br><span class="line">│Consumer2│─────┤   │          │</span><br><span class="line">└─────────┘     │   │          │</span><br><span class="line">┌─────────┐     │   │          │</span><br><span class="line">│Consumer3│─────┘   │          │</span><br><span class="line">└─────────┘         └──────────┘</span><br><span class="line"></span><br><span class="line">步骤2：Coordinator选择一个消费者作为Leader</span><br><span class="line">┌─────────┐         ┌──────────┐</span><br><span class="line">│Consumer1│◄────────│          │</span><br><span class="line">└─────────┘(Leader) │          │</span><br><span class="line">┌─────────┐         │Coordinator</span><br><span class="line">│Consumer2│◄────────│          │</span><br><span class="line">└─────────┘         │          │</span><br><span class="line">┌─────────┐         │          │</span><br><span class="line">│Consumer3│◄────────│          │</span><br><span class="line">└─────────┘         └──────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Sync Group阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">步骤1：Leader消费者制定分区分配方案</span><br><span class="line">┌─────────┐</span><br><span class="line">│Consumer1│ 制定分配方案：</span><br><span class="line">└─────────┘ Consumer1 -&gt; Partition[0,1]</span><br><span class="line">  (Leader)  Consumer2 -&gt; Partition[2,3]</span><br><span class="line">           Consumer3 -&gt; Partition[4,5]</span><br><span class="line"></span><br><span class="line">步骤2：Leader将方案发送给Coordinator</span><br><span class="line">┌─────────┐         ┌──────────┐</span><br><span class="line">│Consumer1│────────&gt;│          │</span><br><span class="line">└─────────┘         │Coordinator</span><br><span class="line">                    │          │</span><br><span class="line">                    └──────────┘</span><br><span class="line"></span><br><span class="line">步骤3：Coordinator将方案下发给所有消费者</span><br><span class="line">┌─────────┐         ┌──────────┐</span><br><span class="line">│Consumer1│◄────────│          │</span><br><span class="line">└─────────┘         │          │</span><br><span class="line">┌─────────┐         │Coordinator</span><br><span class="line">│Consumer2│◄────────│          │</span><br><span class="line">└─────────┘         │          │</span><br><span class="line">┌─────────┐         │          │</span><br><span class="line">│Consumer3│◄────────│          │</span><br><span class="line">└─────────┘         └──────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Heartbeat阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">所有消费者定期发送心跳</span><br><span class="line">┌─────────┐   心跳   ┌──────────┐</span><br><span class="line">│Consumer1│─────────&gt;│          │</span><br><span class="line">└─────────┘         │          │</span><br><span class="line">┌─────────┐         │Coordinator</span><br><span class="line">│Consumer2│─────────&gt;│          │</span><br><span class="line">└─────────┘         │          │</span><br><span class="line">┌─────────┐         │          │</span><br><span class="line">│Consumer3│─────────&gt;│          │</span><br><span class="line">└─────────┘         └──────────┘</span><br><span class="line"></span><br><span class="line">心跳超时：</span><br><span class="line">- session.timeout.ms：心跳超时时间</span><br><span class="line">- heartbeat.interval.ms：心跳发送间隔</span><br><span class="line">- max.poll.interval.ms：消息处理超时时间</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>完整流程示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者配置</span></span><br><span class="line"><span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">props.put(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;my-group&quot;</span>);</span><br><span class="line">props.put(<span class="string">&quot;session.timeout.ms&quot;</span>, <span class="string">&quot;10000&quot;</span>);</span><br><span class="line">props.put(<span class="string">&quot;heartbeat.interval.ms&quot;</span>, <span class="string">&quot;3000&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rebalance监听器</span></span><br><span class="line">consumer.subscribe(topics, <span class="keyword">new</span> <span class="title class_">ConsumerRebalanceListener</span>() &#123;</span><br><span class="line">    <span class="comment">// 再均衡开始前</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPartitionsRevoked</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span> &#123;</span><br><span class="line">        <span class="comment">// 提交偏移量</span></span><br><span class="line">        consumer.commitSync(currentOffsets);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 再均衡完成后</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPartitionsAssigned</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化新分区的消费位置</span></span><br><span class="line">        <span class="keyword">for</span> (TopicPartition partition : partitions) &#123;</span><br><span class="line">            consumer.seek(partition, getLastOffset(partition));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka_rebalance%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka_rebalance%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka-Rebalance机制详解"><a href="#Kafka-Rebalance机制详解" class="headerlink" title="Kafka Rebalance机制详解"></a>Kafka Rebalance机制详解</h1><ol>
<li><p><strong>触发Rebalance的场景</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. 消费组成员变更</span><br><span class="line">   - 新消费者加入消费组</span><br><span class="line">   - 消费者主动离开消费组</span><br><span class="line">   - 消费者崩溃离开消费组</span><br><span class="line"></span><br><span class="line">2. Topic分区数变更</span><br><span class="line">   - 增加分区</span><br><span class="line">   - 管理员手动分区重分配</span><br><span class="line"></span><br><span class="line">3. 订阅Topic数变更</span><br><span class="line">   - 消费者订阅新Topic</span><br><span class="line">   - 正则表达式订阅匹配新Topic</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Rebalance协议流程</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">第一阶段：Join Group</span><br><span class="line">┌─────────┐     ┌─────────┐</span><br><span class="line">│Consumer1│     │Group    │</span><br><span class="line">│Consumer2│ --&gt; │Coordinator</span><br><span class="line">│Consumer3│     │         │</span><br><span class="line">└─────────┘     └─────────┘</span><br><span class="line">发送JoinGroup请求</span><br><span class="line"></span><br><span class="line">第二阶段：Sync Group</span><br><span class="line">┌─────────┐     ┌─────────┐</span><br><span class="line">│Leader   │     │Group    │</span><br><span class="line">│Consumer │ --&gt; │Coordinator</span><br><span class="line">│         │     │         │</span><br><span class="line">└─────────┘     └─────────┘</span><br><span class="line">制定分配方案</span><br><span class="line"></span><br><span class="line">第三阶段：Heart Beat</span><br><span class="line">定期发送心跳保持分配方案</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>分区分配策略</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. RangeAssignor (默认)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RangeAssignor</span> &#123;</span><br><span class="line">    <span class="comment">// 按照分区序号范围划分</span></span><br><span class="line">    <span class="comment">// 例如：6个分区，2个消费者</span></span><br><span class="line">    <span class="comment">// consumer1: [0,1,2]</span></span><br><span class="line">    <span class="comment">// consumer2: [3,4,5]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. RoundRobinAssignor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoundRobinAssignor</span> &#123;</span><br><span class="line">    <span class="comment">// 轮询分配</span></span><br><span class="line">    <span class="comment">// consumer1: [0,2,4]</span></span><br><span class="line">    <span class="comment">// consumer2: [1,3,5]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. StickyAssignor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StickyAssignor</span> &#123;</span><br><span class="line">    <span class="comment">// 粘性分配，尽量保持原有分配</span></span><br><span class="line">    <span class="comment">// 减少分区迁移</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能影响</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Rebalance过程中：</span><br><span class="line">1. 消费者停止消费</span><br><span class="line">2. 释放分区所有权</span><br><span class="line">3. 重新分配分区</span><br><span class="line">4. 重新建立连接</span><br><span class="line">5. 从新位置开始消费</span><br><span class="line"></span><br><span class="line">影响：</span><br><span class="line">- 消费延迟增加</span><br><span class="line">- 消费者暂时不可用</span><br><span class="line">- 可能重复消费</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>优化建议</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 合理配置超时时间</span></span><br><span class="line">props.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, <span class="number">10000</span>);</span><br><span class="line">props.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 选择合适的分配策略</span></span><br><span class="line">props.put(ConsumerConfig.PARTITION_ASSIGNMENT_STRATEGY_CONFIG, </span><br><span class="line">    StickyAssignor.class.getName());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 优雅关闭消费者</span></span><br><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    consumer.wakeup();</span><br><span class="line">    consumer.close();</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>监控指标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">关键指标：</span><br><span class="line">1. Rebalance频率</span><br><span class="line">2. Rebalance持续时间</span><br><span class="line">3. 消费延迟变化</span><br><span class="line">4. 分区分配不均衡度</span><br><span class="line"></span><br><span class="line">告警阈值：</span><br><span class="line">- Rebalance频率 &gt; 10次/小时</span><br><span class="line">- Rebalance时间 &gt; 10秒</span><br><span class="line">- 消费延迟突增 &gt; 1000条</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka%E4%B8%8Eswap%E6%80%A7%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka%E4%B8%8Eswap%E6%80%A7%E8%83%BD/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka性能与Swap的关系"><a href="#Kafka性能与Swap的关系" class="headerlink" title="Kafka性能与Swap的关系"></a>Kafka性能与Swap的关系</h1><ol>
<li><p><strong>Kafka的内存使用模型</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Kafka Broker内存布局：</span><br><span class="line">┌────────────────────┐</span><br><span class="line">│   JVM堆内存        │ &lt;- 存储元数据、缓存等</span><br><span class="line">├────────────────────┤</span><br><span class="line">│   页面缓存         │ &lt;- 消息数据缓存</span><br><span class="line">│   (Page Cache)     │ </span><br><span class="line">└────────────────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>为什么Kafka依赖页面缓存</strong></p>
</li>
</ol>
<ul>
<li>设计理念：<ul>
<li>利用操作系统的页面缓存而不是JVM堆</li>
<li>避免数据在JVM堆和页面缓存的双重缓存</li>
<li>减少GC压力</li>
<li>提供快速的消息读写</li>
</ul>
</li>
</ul>
<ol start="3">
<li><p><strong>Swap对性能的影响</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">当发生Swap时：</span><br><span class="line">1. 页面缓存被换出到磁盘</span><br><span class="line">   内存页 -&gt; Swap分区 (写磁盘)</span><br><span class="line">   </span><br><span class="line">2. 需要数据时再换入内存</span><br><span class="line">   Swap分区 -&gt; 内存页 (读磁盘)</span><br><span class="line">   </span><br><span class="line">结果：一次数据访问变成多次磁盘I/O</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能下降原因</strong></p>
</li>
</ol>
<ul>
<li><p><strong>延迟增加</strong>：</p>
<ul>
<li>正常：内存访问 (~100ns)</li>
<li>Swap：磁盘I&#x2F;O (~10ms)</li>
<li>性能差距：约10万倍</li>
</ul>
</li>
<li><p><strong>吞吐量下降</strong>：</p>
<ul>
<li>频繁的页面换入换出</li>
<li>产生额外的I&#x2F;O负载</li>
<li>影响正常的消息读写</li>
</ul>
</li>
</ul>
<ol start="5">
<li><p><strong>实际影响示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">场景：生产者写入10MB消息</span><br><span class="line"></span><br><span class="line">无Swap情况：</span><br><span class="line">1. 数据写入页面缓存 (内存操作)</span><br><span class="line">2. 异步刷盘 (后台I/O)</span><br><span class="line">总耗时：约10ms</span><br><span class="line"></span><br><span class="line">有Swap情况：</span><br><span class="line">1. 换出页面缓存 (I/O)</span><br><span class="line">2. 写入新数据 (内存操作)</span><br><span class="line">3. 可能需要换入其他数据 (I/O)</span><br><span class="line">4. 异步刷盘 (后台I/O)</span><br><span class="line">总耗时：可能超过100ms</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>最佳实践</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 设置低swappiness</span></span><br><span class="line">vm.swappiness=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 预留足够物理内存</span></span><br><span class="line"><span class="comment"># 计算公式：</span></span><br><span class="line">需要内存 = JVM堆大小 + </span><br><span class="line">         (分区数 × segment.bytes) × 25% + </span><br><span class="line">         预留系统内存</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 监控Swap使用</span></span><br><span class="line">vmstat 1</span><br><span class="line">free -m</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>监控指标</strong></p>
</li>
</ol>
<ul>
<li>si (swap in)：换入数据量</li>
<li>so (swap out)：换出数据量</li>
<li>当这两个值大于0时，说明系统正在使用swap</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="长期激励系统的事件驱动架构设计"><a href="#长期激励系统的事件驱动架构设计" class="headerlink" title="长期激励系统的事件驱动架构设计"></a>长期激励系统的事件驱动架构设计</h1><ol>
<li><p><strong>领域事件模型设计</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 资格变更事件</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QualificationChangedEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String eventId;          <span class="comment">// 事件ID</span></span><br><span class="line">    <span class="keyword">private</span> String employeeId;       <span class="comment">// 员工ID</span></span><br><span class="line">    <span class="keyword">private</span> String planId;           <span class="comment">// 激励方案ID</span></span><br><span class="line">    <span class="keyword">private</span> QualificationStatus status; <span class="comment">// 资格状态</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime changeTime;   <span class="comment">// 变更时间</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; details;<span class="comment">// 变更详情</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 评议完成事件</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReviewCompletedEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String eventId;</span><br><span class="line">    <span class="keyword">private</span> String employeeId;</span><br><span class="line">    <span class="keyword">private</span> String reviewId;</span><br><span class="line">    <span class="keyword">private</span> ReviewResult result;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ReviewComment&gt; comments;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 合同签署事件</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContractSignedEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String eventId;</span><br><span class="line">    <span class="keyword">private</span> String employeeId;</span><br><span class="line">    <span class="keyword">private</span> String contractId;</span><br><span class="line">    <span class="keyword">private</span> ContractStatus status;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime signTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Topic设计与分区策略</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Topic设计：</span><br><span class="line">├── incentive.qualification.changed.v1  # 资格变更事件</span><br><span class="line">├── incentive.review.completed.v1      # 评议完成事件</span><br><span class="line">├── incentive.contract.signed.v1       # 合同签署事件</span><br><span class="line">└── incentive.payment.initiated.v1     # 资金发放事件</span><br><span class="line"></span><br><span class="line">分区策略：</span><br><span class="line">- 按激励方案类型分区</span><br><span class="line">- 确保同一方案的事件顺序性</span><br><span class="line">- 支持并行处理不同方案</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>事件驱动流程</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QualificationService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, Object&gt; kafkaTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateQualification</span><span class="params">(QualificationDTO dto)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 更新资格状态</span></span><br><span class="line">        qualificationRepository.update(dto);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 发送资格变更事件</span></span><br><span class="line">        <span class="type">QualificationChangedEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QualificationChangedEvent</span>();</span><br><span class="line">        <span class="comment">// ... 设置事件属性</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 使用方案ID作为key，确保分区顺序</span></span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;incentive.qualification.changed.v1&quot;</span>, </span><br><span class="line">                         dto.getPlanId(), </span><br><span class="line">                         event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReviewService</span> &#123;</span><br><span class="line">    <span class="meta">@KafkaListener(</span></span><br><span class="line"><span class="meta">        topics = &quot;incentive.qualification.changed.v1&quot;,</span></span><br><span class="line"><span class="meta">        groupId = &quot;review-service-group&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleQualificationChanged</span><span class="params">(QualificationChangedEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 幂等性检查</span></span><br><span class="line">        <span class="keyword">if</span> (eventProcessed(event.getEventId())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 创建评议任务</span></span><br><span class="line">        <span class="type">ReviewTask</span> <span class="variable">task</span> <span class="operator">=</span> createReviewTask(event);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 发送评议创建事件</span></span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;incentive.review.created.v1&quot;</span>, </span><br><span class="line">                         event.getPlanId(), </span><br><span class="line">                         <span class="keyword">new</span> <span class="title class_">ReviewCreatedEvent</span>(task));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>事件驱动架构价值</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. 业务解耦</span><br><span class="line">   - 服务间通过事件异步通信</span><br><span class="line">   - 降低系统耦合度</span><br><span class="line">   - 便于服务独立扩展</span><br><span class="line"></span><br><span class="line">2. 数据一致性</span><br><span class="line">   - 最终一致性保证</span><br><span class="line">   - 通过事件溯源恢复状态</span><br><span class="line">   - 完整的业务链路追踪</span><br><span class="line"></span><br><span class="line">3. 性能提升</span><br><span class="line">   - 异步处理提高响应速度</span><br><span class="line">   - 削峰填谷</span><br><span class="line">   - 支持水平扩展</span><br><span class="line"></span><br><span class="line">4. 业务灵活性</span><br><span class="line">   - 新增功能只需订阅事件</span><br><span class="line">   - 便于实现业务监控</span><br><span class="line">   - 支持事件回放和重试</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>可靠性保证</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ProducerFactory&lt;String, Object&gt; <span class="title function_">producerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; config = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 可靠性配置</span></span><br><span class="line">        config.put(ProducerConfig.ACKS_CONFIG, <span class="string">&quot;all&quot;</span>);</span><br><span class="line">        config.put(ProducerConfig.RETRIES_CONFIG, <span class="number">3</span>);</span><br><span class="line">        config.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaProducerFactory</span>&lt;&gt;(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka%E5%86%85%E5%AD%98%E5%85%B3%E7%B3%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka%E5%86%85%E5%AD%98%E5%85%B3%E7%B3%BB/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka内存架构与页面缓存关系"><a href="#Kafka内存架构与页面缓存关系" class="headerlink" title="Kafka内存架构与页面缓存关系"></a>Kafka内存架构与页面缓存关系</h1><ol>
<li><p><strong>Linux内存整体架构</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">物理内存布局：</span><br><span class="line">┌────────────────────┐</span><br><span class="line">│    用户空间        │ &lt;- 应用程序、JVM堆</span><br><span class="line">│  (User Space)      │    进程私有内存</span><br><span class="line">├────────────────────┤</span><br><span class="line">│    内核空间        │ &lt;- 内核代码、数据结构</span><br><span class="line">│  (Kernel Space)    │    共享内存区域</span><br><span class="line">│    ├─────────────┐ │</span><br><span class="line">│    │ 页面缓存    │ │ &lt;- 磁盘文件缓存</span><br><span class="line">│    │(Page Cache) │ │    所有进程共享</span><br><span class="line">│    └─────────────┘ │</span><br><span class="line">└────────────────────┘</span><br><span class="line">      ↓</span><br><span class="line">┌────────────────────┐</span><br><span class="line">│    Swap空间        │ &lt;- 虚拟内存，磁盘上的交换分区</span><br><span class="line">└────────────────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kafka的内存使用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Kafka Broker内存分布：</span><br><span class="line">┌────────────────────┐</span><br><span class="line">│    JVM堆(6-8G)    │ &lt;- 用户空间</span><br><span class="line">│  - 消息元数据      │    broker进程私有</span><br><span class="line">│  - 消费者元数据    │</span><br><span class="line">│  - 副本状态等      │</span><br><span class="line">├────────────────────┤</span><br><span class="line">│    页面缓存        │ &lt;- 内核空间</span><br><span class="line">│  - 消息数据        │    所有进程共享</span><br><span class="line">│  - 索引文件        │    由操作系统管理</span><br><span class="line">└────────────────────┘</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>页面缓存的作用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Kafka使用页面缓存：</span><br><span class="line">1. 读操作</span><br><span class="line">   磁盘 -&gt; 页面缓存 -&gt; 网络接口(零拷贝)</span><br><span class="line">   </span><br><span class="line">2. 写操作</span><br><span class="line">   网络 -&gt; 页面缓存 -&gt; 异步刷盘</span><br><span class="line"></span><br><span class="line">优势：</span><br><span class="line">- 避免JVM GC压力</span><br><span class="line">- 利用操作系统的缓存机制</span><br><span class="line">- 支持零拷贝技术</span><br><span class="line">- 多进程共享缓存数据</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Swap与页面缓存的区别</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">页面缓存：</span><br><span class="line">- 缓存磁盘文件数据</span><br><span class="line">- 位于内核空间</span><br><span class="line">- 所有进程共享</span><br><span class="line">- 命中时直接返回数据</span><br><span class="line">- 未命中时从磁盘读取</span><br><span class="line"></span><br><span class="line">Swap空间：</span><br><span class="line">- 存储内存页面数据</span><br><span class="line">- 位于磁盘上</span><br><span class="line">- 进程私有</span><br><span class="line">- 访问时需要换入内存</span><br><span class="line">- 会导致性能下降</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>内存压力场景</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">当内存不足时的处理顺序：</span><br><span class="line">1. 释放页面缓存</span><br><span class="line">2. 回收可回收内存</span><br><span class="line">3. 使用Swap空间</span><br><span class="line"></span><br><span class="line">对Kafka的影响：</span><br><span class="line">- 页面缓存被释放：性能下降但可接受</span><br><span class="line">- 发生Swap：严重性能问题</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>最佳实践</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">内存配置建议：</span><br><span class="line">1. 预留足够页面缓存</span><br><span class="line">   - 建议为总内存的50%</span><br><span class="line">   - 例：16G内存预留8G页面缓存</span><br><span class="line"></span><br><span class="line">2. 控制JVM堆大小</span><br><span class="line">   - 建议6-8G</span><br><span class="line">   - 避免过大堆影响页面缓存</span><br><span class="line"></span><br><span class="line">3. 最小化Swap使用</span><br><span class="line">   - 设置vm.swappiness=1</span><br><span class="line">   - Swap大小控制在1-2G</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka的MMAP-Memory-Mapped-Files-实现"><a href="#Kafka的MMAP-Memory-Mapped-Files-实现" class="headerlink" title="Kafka的MMAP(Memory Mapped Files)实现"></a>Kafka的MMAP(Memory Mapped Files)实现</h1><ol>
<li><p><strong>什么是MMAP</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">内存映射文件原理：</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   用户进程      │</span><br><span class="line">│ ┌───────────┐  │</span><br><span class="line">│ │映射的内存区域│  │     映射</span><br><span class="line">└─│───────────│──┘ ←──────────┐</span><br><span class="line">  └─────┬─────┘             │</span><br><span class="line">        │                   │</span><br><span class="line">┌───────┼───────────────────┼─┐</span><br><span class="line">│     页面缓存              │ │</span><br><span class="line">│   ┌─────────────┐         │ │</span><br><span class="line">│   │  文件数据   │ ←───────┘ │</span><br><span class="line">│   └─────────────┘           │</span><br><span class="line">└─────────────────────────────┘</span><br><span class="line">        内核空间</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kafka中的使用场景</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Kafka源码中的应用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileRecords</span> <span class="keyword">extends</span> <span class="title class_">AbstractRecords</span> &#123;</span><br><span class="line">    <span class="comment">// 索引文件映射</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MappedByteBuffer mmap;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileRecords</span><span class="params">(File file, <span class="type">boolean</span> mmap)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (mmap) &#123;</span><br><span class="line">            <span class="comment">// 创建内存映射</span></span><br><span class="line">            <span class="built_in">this</span>.mmap = Utils.mmap(file, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">主要用途：</span><br><span class="line"><span class="number">1.</span> 索引文件访问</span><br><span class="line">   - offset索引</span><br><span class="line">   - timestamp索引</span><br><span class="line">   - leader epoch索引</span><br><span class="line">   </span><br><span class="line"><span class="number">2.</span> 小分区的消息日志</span><br><span class="line">   - 默认配置：segment.bytes=1GB</span><br><span class="line">   - 可配置是否使用mmap</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>映射过程</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简化的映射过程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MappedByteBuffer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 打开文件通道</span></span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> FileChannel.open(path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 创建映射</span></span><br><span class="line">    <span class="type">MappedByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> channel.map(</span><br><span class="line">        FileChannel.MapMode.READ_WRITE,  <span class="comment">// 映射模式</span></span><br><span class="line">        <span class="number">0</span>,                              <span class="comment">// 起始位置</span></span><br><span class="line">        file.length()                   <span class="comment">// 映射长度</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 直接操作内存</span></span><br><span class="line">    buffer.putInt(<span class="number">1</span>);      <span class="comment">// 写入数据</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> buffer.getInt();  <span class="comment">// 读取数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>优缺点分析</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">优点：</span><br><span class="line">1. 零拷贝读写</span><br><span class="line">   - 避免内核空间到用户空间的拷贝</span><br><span class="line">   - 减少上下文切换</span><br><span class="line"></span><br><span class="line">2. 页面自动管理</span><br><span class="line">   - 由操作系统管理页面调度</span><br><span class="line">   - 支持预读和回写</span><br><span class="line"></span><br><span class="line">缺点：</span><br><span class="line">1. 内存占用</span><br><span class="line">   - 映射文件会占用虚拟内存</span><br><span class="line">   - 大文件映射需要注意内存限制</span><br><span class="line"></span><br><span class="line">2. 页面错误</span><br><span class="line">   - 首次访问会触发页面错误</span><br><span class="line">   - 可能导致延迟波动</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置与调优</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># broker配置</span></span><br><span class="line"><span class="comment"># 是否使用mmap</span></span><br><span class="line"><span class="attr">log.segment.bytes</span>=<span class="string">1073741824</span></span><br><span class="line"><span class="attr">file.mmap.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 系统配置</span></span><br><span class="line"><span class="comment"># 最大映射区域</span></span><br><span class="line"><span class="attr">vm.max_map_count</span>=<span class="string">262144</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>最佳实践</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">使用建议：</span><br><span class="line">1. 小文件优先使用mmap</span><br><span class="line">   - 索引文件</span><br><span class="line">   - 小分区日志</span><br><span class="line"></span><br><span class="line">2. 大文件使用直接I/O</span><br><span class="line">   - 大分区日志</span><br><span class="line">   - 避免内存压力</span><br><span class="line"></span><br><span class="line">3. 监控指标</span><br><span class="line">   - 页面错误率</span><br><span class="line">   - 内存映射区域数量</span><br><span class="line">   - 虚拟内存使用率</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://guohaolu.github.io/2025/10/14/kafka%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guohao.lu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guohao Lu's Blog">
      <meta itemprop="description" content="分享技术，记录生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Guohao Lu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/14/kafka%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-14 10:16:14" itemprop="dateCreated datePublished" datetime="2025-10-14T10:16:14+08:00">2025-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kafka服务器内存配置最佳实践"><a href="#Kafka服务器内存配置最佳实践" class="headerlink" title="Kafka服务器内存配置最佳实践"></a>Kafka服务器内存配置最佳实践</h1><ol>
<li><p><strong>16G内存的最佳分配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">建议分配：</span><br><span class="line">┌────────────────────┐</span><br><span class="line">│ 系统预留: 2G      │ &lt;- 操作系统和其他进程使用</span><br><span class="line">├────────────────────┤</span><br><span class="line">│ Kafka堆内存: 6G   │ &lt;- broker的JVM堆内存</span><br><span class="line">├────────────────────┤</span><br><span class="line">│ 页面缓存: 8G      │ &lt;- 用于消息数据缓存</span><br><span class="line">└────────────────────┘</span><br><span class="line"></span><br><span class="line">Swap建议：</span><br><span class="line">- 默认4G -&gt; 调整为1-2G</span><br><span class="line">- 设置vm.swappiness=1</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>为什么要减少Swap</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">原因：</span><br><span class="line">1. Kafka性能严重依赖于页面缓存</span><br><span class="line">2. 一旦发生Swap：</span><br><span class="line">   - 页面缓存被换出到磁盘</span><br><span class="line">   - 数据访问延迟从ns级变为ms级</span><br><span class="line">   - 吞吐量显著下降</span><br><span class="line">   - 可能引发消息积压</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能对比</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">场景：生产者写入1GB数据</span><br><span class="line"></span><br><span class="line">正常配置（小Swap）：</span><br><span class="line">- 写入延迟：~10ms</span><br><span class="line">- 吞吐量：~100MB/s</span><br><span class="line">- 页面缓存命中率：95%</span><br><span class="line"></span><br><span class="line">大Swap配置：</span><br><span class="line">- 写入延迟：可能超过100ms</span><br><span class="line">- 吞吐量：可能降至10MB/s</span><br><span class="line">- 频繁的页面换入换出</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置建议</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 调整Swap大小</span></span><br><span class="line"><span class="built_in">sudo</span> swapoff -a</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1G count=2</span><br><span class="line"><span class="built_in">sudo</span> mkswap /swapfile</span><br><span class="line"><span class="built_in">sudo</span> swapon /swapfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 修改swappiness</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;vm.swappiness=1&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 设置Kafka堆内存</span></span><br><span class="line"><span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">&quot;-Xms6g -Xmx6g&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>监控指标</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控Swap使用</span></span><br><span class="line">vmstat 1</span><br><span class="line">free -m</span><br><span class="line"></span><br><span class="line">关键指标：</span><br><span class="line">- si (swap <span class="keyword">in</span>) 应接近0</span><br><span class="line">- so (swap out) 应接近0</span><br><span class="line">- swap used 应保持稳定</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>风险防范</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. 内存使用监控</span><br><span class="line">   - 设置内存使用率告警</span><br><span class="line">   - 阈值建议：80%</span><br><span class="line"></span><br><span class="line">2. Swap使用监控</span><br><span class="line">   - 设置Swap使用告警</span><br><span class="line">   - 一旦发生Swap及时处理</span><br><span class="line"></span><br><span class="line">3. 性能指标监控</span><br><span class="line">   - 生产者延迟</span><br><span class="line">   - 消费者延迟</span><br><span class="line">   - 页面缓存命中率</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">true</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
